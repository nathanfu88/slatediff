{"version":3,"sources":["../src/slateDiff.js"],"names":["pathConv","slateDiff","pathStr","result","match","map","parseInt","v","path","slice","length","offset","slateRemoveOp","type","text","marks","slateAddTextOp","value","slateAddNodeOp","node","fromJSON","toJSON","value1","value2","differences","document","slateOps","d","op","get","obj","object","console","error","concat","toJS"],"mappings":"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","file":"slateDiff.js","sourcesContent":["import diff from './diff'\r\nimport { Value, Block } from 'slate'\r\n\r\nexport function pathConv(pathStr) {\r\n  const result = pathStr.match(/\\d+/g).map(v => {\r\n    return parseInt(v, 10)\r\n  })\r\n  let path = result.slice(0, result.length-1)\r\n  const offset = result[result.length-1]\r\n\r\n  // Handle single node path\r\n  if (path.length === 0) { path = [ offset ] }\r\n\r\n  return { path, offset }\r\n}\r\n\r\nfunction slateRemoveOp(path, offset) {\r\n  return {\r\n    type: 'remove_text',\r\n    path: path,\r\n    offset: offset,\r\n    text: '*',\r\n    // TODO: How are marks handled?\r\n    marks: []\r\n  }\r\n}\r\n\r\nfunction slateAddTextOp(path, offset, value) {\r\n  return {\r\n    type: 'insert_text',\r\n    path: path,\r\n    offset: offset,\r\n    text: value,\r\n    // TODO: Get marks from `value`\r\n    marks: []\r\n  }\r\n}\r\n\r\nfunction slateAddNodeOp(path, offset, value) {\r\n  return {\r\n    type: 'insert_node',\r\n    path: path,\r\n    node: Block.fromJSON(value.toJSON())\r\n  }\r\n}\r\n\r\nexport default function slateDiff(value1, value2) {\r\n  const differences = diff(value1.document, value2.document)\r\n\r\n  const slateOps = differences.map((d) => {\r\n    const op = d.get('op')\r\n    const { path, offset } = pathConv(d.get('path'))\r\n    if (op === 'remove') {\r\n      return slateRemoveOp(path, offset)\r\n    }\r\n    else if (op === 'add') {\r\n      const value = d.get('value')\r\n      // Safe to assume value has .object?\r\n      const obj = value.object\r\n      if (obj === 'character') {\r\n        return slateAddTextOp(path, offset, value.text)\r\n      }\r\n      else if (obj === 'block') {\r\n        return slateAddNodeOp(path, offset, value)\r\n      }\r\n      else {\r\n        console.error('Unhandled value.object type ', obj)\r\n        return\r\n      }\r\n    }\r\n    else if (op === 'replace') {\r\n      const value = d.get('value')\r\n      return [\r\n        slateRemoveOp(path, offset), slateAddTextOp(path, offset, value)\r\n      ]\r\n    }\r\n    else {\r\n      console.error('Unhandled operation ', op)\r\n      return\r\n    }\r\n  })\r\n\r\n  // Flatten for `replace`\r\n  return [].concat(...slateOps.toJS())\r\n}"]}